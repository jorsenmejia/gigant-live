var HOUR_OFFSET=12,wc_appointments_date_picker={};jQuery(document).ready(function(E){"use strict";var y,g,N={},t=window.navigator.userLanguage||window.navigator.language,d={init:function(){E("body").on("change","#wc_appointments_field_staff",this.staff_calendar),E("body").on("click",".wc-appointments-date-picker legend small.wc-appointments-date-picker-choose-date",this.toggle_calendar),E("body").on("click",".appointment_date_year, .appointment_date_month, .appointment_date_day",this.open_calendar),E("body").on("input",".appointment_date_year, .appointment_date_month, .appointment_date_day",this.input_date_trigger),E("body").on("change",".appointment_to_date_year, .appointment_to_date_month, .appointment_to_date_day",this.input_date_trigger),E(".wc-appointments-date-picker legend small.wc-appointments-date-picker-choose-date").show(),E(".wc-appointments-date-picker").each(function(){var s=E(this).closest("form"),r=s.find(".picker:eq(0)"),t=E(this).closest("fieldset"),e=r.attr("data-duration_unit");-1===E.inArray(e,["minute","hour"])&&s.on("addon-duration-changed",function(t,e){var a=parseInt(r.attr("data-appointment_duration"),10),i=parseInt(e,10),n=parseInt(a+i,10);r.data("combined_duration",n),r.data("addon_duration",e),wc_appointments_date_picker.highlight_days(s)}),wc_appointments_date_picker.date_picker_init(r),E(".wc-appointments-date-picker-date-fields",t).hide(),E(".wc-appointments-date-picker-choose-date",t).hide()})},highlight_days:function(t){var e=t.find(".picker"),a=e.find("td.ui-datepicker-current-day").not(".ui-state-disabled"),i=e.attr("data-appointment_duration"),n=e.data("combined_duration")?e.data("combined_duration"):i,s=(n<1?1:n)-1;e.find("td").removeClass("ui-datepicker-selected-day"),0<s&&a.nextAll("td").add(a.closest("tr").nextAll().find("td")).slice(0,s).addClass("ui-datepicker-selected-day")},staff_calendar:function(){var t=E(this).closest("form").find(".picker:eq(0)");wc_appointments_date_picker.date_picker_init(t)},toggle_calendar:function(){var t=E(this).closest("fieldset").find(".picker:eq(0)");wc_appointments_date_picker.date_picker_init(t),t.slideToggle()},open_calendar:function(){var t=E(this).closest("fieldset").find(".picker:eq(0)");wc_appointments_date_picker.date_picker_init(t),t.slideDown()},input_date_trigger:function(){var t=E(this).closest("fieldset"),e=t.find(".picker:eq(0)"),a=parseInt(t.find("input.appointment_date_year").val(),10),i=parseInt(t.find("input.appointment_date_month").val(),10),n=parseInt(t.find("input.appointment_date_day").val(),10);if(a&&i&&n){var s=new Date(a,i-1,n);e.datepicker("setDate",s)}},select_date_trigger:function(t){var e=E(this).closest("fieldset"),a=e.closest("form"),i=a.find(".picker:eq(0)"),n=t.split("-"),s=parseInt(n[0],10),r=parseInt(n[1],10),d=parseInt(n[2],10),_=i.attr("data-duration_unit"),o=i.attr("data-appointment_duration"),p=i.data("combined_duration")?i.data("combined_duration"):o;if(-1===E.inArray(_,["minute","hour"])){var c=p<1?1:p;y=new Date(s,r-1,d),g=new Date(s,r-1,d+(parseInt(c,10)-1))}e.find("input.appointment_to_date_year").val(""),e.find("input.appointment_to_date_month").val(""),e.find("input.appointment_to_date_day").val(""),e.find("input.appointment_date_year").val(n[0]),e.find("input.appointment_date_month").val(n[1]),e.find("input.appointment_date_day").val(n[2]).change(),a.find(".wc-appointments-appointment-form-button").prop("disabled",!0),a.triggerHandler("date-selected",t)},date_picker_init:function(t){var e=new a(t);null!==wca_get_querystring("date")&&wca_is_valid_date(wca_get_querystring("date"))&&e.set_default_params({defaultDate:wca_get_querystring("date")}),e.set_default_params({onSelect:wc_appointments_date_picker.select_date_trigger,minDate:e.get_data_attr("min_date"),maxDate:e.get_data_attr("max_date"),defaultDate:wca_get_querystring("date"),changeMonth:e.get_custom_data("changeMonth"),changeYear:e.get_custom_data("changeYear"),showWeek:e.get_custom_data("showWeek"),showOn:e.get_custom_data("showOn"),numberOfMonths:parseInt(e.get_custom_data("numberOfMonths")),showButtonPanel:e.get_custom_data("showButtonPanel"),showOtherMonths:e.get_custom_data("showOtherMonths"),selectOtherMonths:e.get_custom_data("selectOtherMonths"),gotoCurrent:e.get_custom_data("gotoCurrent"),closeText:e.get_custom_data("closeText"),currentText:e.get_custom_data("currentText"),prevText:e.get_custom_data("prevText"),nextText:e.get_custom_data("nextText"),monthNames:e.get_custom_data("monthNames"),monthNamesShort:e.get_custom_data("monthNamesShort"),dayNames:e.get_custom_data("dayNames"),dayNamesMin:e.get_custom_data("dayNamesShort"),firstDay:e.get_custom_data("firstDay"),isRTL:e.get_custom_data("isRTL"),beforeShowDay:e.maybe_load_from_cache.bind(e),onChangeMonthYear:function(t,e){this.get_data(t,e).done(this.applyStylesToDates)}.bind(e)}),e.create(),wc_appointments_date_picker.get_day_attributes=e.maybe_load_from_cache.bind(e)},refresh_datepicker:function(){E(".wc-appointments-date-picker").find(".picker:eq(0)").datepicker("refresh")},get_number_of_days:function(t,e,a){var i=t,n=a.attr("data-duration_unit"),s=a.attr("data-appointment_duration"),r=a.data("combined_duration")?a.data("combined_duration"):s,d=a.attr("data-availability_span");return-1===E.inArray(n,["minute","hour"])&&(i=r<1?1:r),(i<1||"start"===d)&&(i=1),i},is_slot_appointable:function(t){for(var e=t.default_availability,a=0;a<t.number_of_days;a++){var i=new Date(t.start_date);i.setDate(i.getDate()+a);var n=i.getFullYear(),s=i.getMonth()+1,r=i.getDate(),d=i.getDay(),_=n+"-"+s+"-"+r;0===d&&(d=7);var o={date:i,staff_id:t.staff_id,default_availability:t.default_availability,availability:t.availability};if(e=wc_appointments_date_picker.is_staff_available_on_date(o),"all"===t.staff_assignment&&t.has_staff){var p=E.extend({availability:t.availability,fully_scheduled_days:t.fully_scheduled_days},o);e=wc_appointments_date_picker.has_all_available_staff(p)}else if("customer"===t.staff_assignment&&0===t.staff_id&&t.has_staff&&1<t.has_staff){var c=E.extend({availability:t.availability,fully_scheduled_days:t.fully_scheduled_days,staff_count:t.has_staff},o);e=wc_appointments_date_picker.has_any_available_staff(c)}if(t.fully_scheduled_days[_]&&(t.fully_scheduled_days[_][0]||t.fully_scheduled_days[_][t.staff_id])&&(e=!1),!e)break}return e},rrule_cache:{},is_staff_available_on_date:function($){if("object"!=typeof $||"object"!=typeof $.availability)return!1;var t=$.default_availability,F=$.date.getFullYear(),Y=$.date.getMonth()+1,S=$.date.getDate(),j=$.date.getDay(),e=F+"-"+Y+"-"+S,q=parseInt($.staff_id),a=new Date(F,0,1),H=Math.ceil((($.date-a)/864e5+a.getDay()+1)/7);if(0===j&&(j=7),$.fully_scheduled_days&&$.fully_scheduled_days[e]&&$.fully_scheduled_days[e][q])return!1;var C=[],A=_.range(1,1440,1);return t&&(C=A),E.each($.availability,function(t,e){var s,a=e.type,r=e.range,i=e.level,n=parseInt(e.kind_id);if(E.isArray(r))return!0;if(void 0!==q&&q&&0!==q&&"staff"===i&&q!==n)return!0;try{switch(a){case"months":if("undefined"!=typeof r[Y])return C=r[Y]?A:[],!0;break;case"weeks":if("undefined"!=typeof r[H])return C=r[H]?A:[],!0;break;case"days":if("undefined"!=typeof r[j])return C=r[j]?A:[],!0;break;case"custom":if("undefined"!=typeof r[F][Y][S])return C=r[F][Y][S]?A:[],!0;break;case"rrule":var d=-1===r.from.indexOf(":"),o=moment.utc($.date).clone().startOf("day"),p=moment.utc(r.from),c=d?moment.utc(r.to).add(1,"days"):moment.utc(r.to),l=moment.duration(c.diff(p)),u=rrule.rrulestr(r.rrule,{dtstart:p.toDate()}),f=t+N.startDate+N.endDate;"undefined"==typeof wc_appointments_date_picker.rrule_cache[f]&&(wc_appointments_date_picker.rrule_cache[f]=u.between(moment.utc(N.startDate).subtract(l).subtract(1,"days").toDate(),moment.utc(N.endDate).subtract(l).add(1,"days").toDate(),!0).map(function(t){return new moment(t)})),wc_appointments_date_picker.rrule_cache[f].forEach(function(t){var e=t.clone().startOf("day"),a=t.clone().add(l),i=a.clone().startOf("day");if(o.isSameOrAfter(e)&&o.isBefore(i))if(d)C=r.rule?A:[];else if(o.isSame(e)){var n=moment.duration(t.diff(e)).asMinutes();s=_.range(n,n+l.asMinutes(),1),C=r.rule?_.union(C,s):_.difference(C,s)}else o.isAfter(e)&&o.isBefore(i)?C=r.rule?A:[]:o.isSame(i)&&(s=_.range(1,moment.duration(a.diff(i)).asMinutes(),1),C=r.rule?_.union(C,s):_.difference(C,s))});break;case"time":case"time:1":case"time:2":case"time:3":case"time:4":case"time:5":case"time:6":case"time:7":var m=parseInt(r.from.split(":")[0]),h=parseInt(r.from.split(":")[1])+60*m,y=parseInt(r.to.split(":")[0]),g=parseInt(r.to.split(":")[1]),D=g+60*y,b=!1,v=0==j-1?7:j-1;if(!(0===y&&0===g)&&D<=h&&r.day===v&&(b=r.day),j===r.day||0===r.day||b===r.day)return D<=h&&(D=g+60*(y+=24)),s=_.range(h,D,1),C=r.rule?_.union(C,s):_.difference(C,s),!0;break;case"time:range":case"custom:daterange":r=r[F][Y][S];var k=parseInt(r.from.split(":")[0]),w=parseInt(r.from.split(":")[1]),O=parseInt(r.to.split(":")[0]),x=parseInt(r.to.split(":")[1]);O<=k&&x<=w&&(O+=24);var M=w+60*k,I=x+60*O;s=_.range(M,I,1),C=r.rule?_.union(C,s):_.difference(C,s)}}catch(T){return!0}}),!_.isEmpty(C)},get_week_number:function(t){var e=new Date(t.getFullYear(),0,1);return Math.ceil(((t-e)/864e5+e.getDay()+1)/7)},has_all_available_staff:function(n){var s=[];return"object"==typeof n&&"object"==typeof n.availability&&(E.each(n.availability,function(t,e){var a=e.level,i=parseInt(e.kind_id);if("staff"!==a||!i)return!0;n.staff_id=i,wc_appointments_date_picker.is_staff_available_on_date(n)||s.push(!1)}),!s.includes(!1))},has_any_available_staff:function(n){var s=[];return"object"==typeof n&&"object"==typeof n.availability&&(E.each(n.availability,function(t,e){var a=e.level,i=parseInt(e.kind_id);if("staff"!==a||!i)return!0;n.staff_id=i,wc_appointments_date_picker.is_staff_available_on_date(n)&&s.push(!0)}),!!s.includes(!0))},get_format_date:function(t){return t.getFullYear()+"-"+((t.getMonth()+1<10?"0":"")+(t.getMonth()+1))+"-"+((t.getDate()<10?"0":"")+t.getDate())},get_relative_date:function(t){for(var e=new Date,a=/([+-]?[0-9]+)\s*(d|D|w|W|m|M|y|Y)?/g,i=a.exec(t);i;){switch(i[2]||"d"){case"d":case"D":e.setDate(e.getDate()+parseInt(i[1],10));break;case"w":case"W":e.setDate(7*(e.getDate()+parseInt(i[1],10)));break;case"m":case"M":e.setMonth(e.getMonth()+parseInt(i[1],10));break;case"y":case"Y":e.setYear(e.getFullYear()+parseInt(i[1],10))}i=a.exec(t)}return e},find_available_date_within_month:function(){var i=[];return E.each(E(".appointable:not(.ui-state-disabled)").find(".ui-state-default"),function(t,e){var a=+E(e).text();a&&i.push(a)}),i[0]},filter_selectable_day:function(t,e){return t.filter(function(){return Number(E(this).text())===e})},filter_day_parent:function(t,e){return t.filter(function(){return Number(E(this).text())===e}).parent()},add_selector_attributes:function(a,t){E.each(t,function(t,e){a.attr(t,E.isArray(e)?e.join(" "):e)})}},a=function a(t){this.$picker=E(t),this.$form=this.$picker.closest("form, .cart"),this.customData={},this.opts={cache:!1},this.cache={data:{},attributes:{}},E.each(wc_appointment_form_params,function(t,e){this.customData[t]=e}.bind(this)),!this.customData.cache_ajax_requests||"true"!==this.customData.cache_ajax_requests.toLowerCase()&&"false"!==this.customData.cache_ajax_requests.toLowerCase()||(this.opts.cache="true"===this.customData.cache_ajax_requests.toLowerCase())};a.prototype.create=function(){var t=parseInt(this.$form.find("input.appointment_date_year").val(),10),e=parseInt(this.$form.find("input.appointment_date_month").val(),10),a=parseInt(this.$form.find("input.appointment_date_day").val(),10),s=this.get_default_date();this.$picker.empty().removeClass("hasDatepicker").datepicker(this.get_default_params()),t&&e&&a&&this.$picker.datepicker("setDate",new Date(t,e-1,a));var i=this.$picker.datepicker("getDate").getFullYear(),n=this.$picker.datepicker("getDate").getMonth()+1;this.get_data(i,n).done(this.applyStylesToDates).done(function(){var t,e,a,i=this.$picker.attr("data-is_autoselect");if(null===wca_get_querystring("date")&&i||null!==wca_get_querystring("date")&&wca_is_valid_date(wca_get_querystring("date")))if(this.$picker.datepicker("refresh"),this.$picker.find(".ui-datepicker-current-day").hasClass("ui-datepicker-unselectable")&&this.$picker.datepicker("setDate",new Date(s.getFullYear(),s.getMonth()-1,1)),(t=this.$picker.find(".ui-datepicker-current-day")).hasClass("ui-datepicker-unselectable"))for(var n=1;n<12;n++){if(e=wc_appointments_date_picker.find_available_date_within_month(),0<(a=wc_appointments_date_picker.filter_selectable_day(E(".ui-state-default"),e)).length){a.click();break}this.$picker.find(".ui-datepicker-next").click()}else t.click();else E(".ui-datepicker-current-day").removeClass("ui-datepicker-current-day")})},a.prototype.applyStylesToDates=function(t){(N=t).startDate.setHours(HOUR_OFFSET),t.endDate.setHours(HOUR_OFFSET);for(var e=new Date(t.startDate.valueOf());e<t.endDate;){var a=e.getTime();if(!this.cache.attributes[a]){var i=this.getDateElementAttributes(e),n=wc_appointments_date_picker.filter_day_parent(E('td[data-month="'+e.getMonth()+'"] a',this.$picker),e.getDate());i.selectable||(i["class"].push("ui-datepicker-unselectable"),i["class"].push("ui-state-disabled")),e.setHours(HOUR_OFFSET,0,0,0)===(new Date).setHours(HOUR_OFFSET,0,0,0)&&i["class"].push("ui-datepicker-today"),n.hasClass("ui-datepicker-current-day")&&i["class"].push("ui-datepicker-current-day"),wc_appointments_date_picker.add_selector_attributes(n,i),this.opts.cache&&(this.cache.attributes[a]=i)}e.setDate(e.getDate()+1)}},a.prototype.maybe_load_from_cache=function(t){var e=t.getTime(),a=[!0,"1"===this.customData.default_availability?"appointable":"not-appointable",""],i=this.cache.attributes[e];if(i)i=[i.selectable,i["class"].join(" "),i.title];else if(this.appointmentsData){var n=new Date(t);n.setHours(HOUR_OFFSET);var s=this.getDateElementAttributes(n);a=[s.selectable,s["class"].join(" "),s.title]}return i||a},a.prototype.get_default_params=function(){return this.defaultParams||{}},a.prototype.set_default_params=function(t){var e={showWeek:!1,showOn:!1,numberOfMonths:1,showButtonPanel:!1,showOtherMonths:!0,selectOtherMonths:!0,gotoCurrent:!0,dateFormat:E.datepicker.ISO_8601};if("object"!=typeof t)throw new Error("Cannot set params with typeof "+typeof t);this.defaultParams=E.extend(e,t)||{}},a.prototype.get_data=function(a,i){var n=function n(t){t=t||new Date([a,i,"01"].join("/"));var e=this.get_number_of_days_in_month(i);return this.get_padded_date_range(t,e)}.bind(this),e=E.Deferred(),s=n(),r=s.startDate.getTime()+"-"+s.endDate.getTime();if(this.opts.cache&&this.cache.data[r])e.resolveWith(this,[s,this.cache.data[r]]);else{var t={"wc-ajax":"wc_appointments_find_scheduled_day_slots",product_id:this.$picker.attr("data-product_id"),security:this.get_custom_data("nonce_find_day_slots")};this.$picker.block({message:null,overlayCSS:{background:"#fff",opacity:.6}}),t.min_date=moment(s.startDate).format("YYYY-MM-DD"),t.max_date=moment(s.endDate).format("YYYY-MM-DD"),E.ajax({context:this,url:wc_appointments_date_picker_args.ajax_url,method:"POST",data:t}).done(function(t){this.appointmentsData=this.appointmentsDate||{},E.each(t,function(t,e){if(E.isArray(e)||"object"==typeof e){var a=E.isArray(e)?[]:{};this.appointmentsData[t]=this.appointmentsData[t]||a,E.extend(this.appointmentsData[t],e)}else this.appointmentsData[t]=e}.bind(this)),d.appointmentsData=this.appointmentsData,this.cache.data[r]=t,a||i||!this.appointmentsData.min_date||(s=n(this.get_default_date(this.appointmentsData.min_date))),e.resolveWith(this,[s,t]),this.$picker.unblock(),this.$form.triggerHandler("calendar-data-loaded",[this.appointmentsData,s])}.bind(this))}return e},a.prototype.get_default_date=function(t){var e,a=this.$picker.data("default_date").split("-");a[2]="31";var i=1;if(e=3!==a.length?new Date:new Date(a),t){switch(t.unit){case"month":i=30;break;case"week":i=7}i*=t.value,e.setDate(e.getDate()+i)}return e},a.prototype.get_number_of_days_in_month=function(t){var e=this.get_default_date();return t=t||e.getMonth()+1,new Date(e.getFullYear(),t,0).getDate()},a.prototype.get_custom_data=function(t){if(t)return this.customData[t]||null},a.prototype.get_data_attr=function(t){if(t)return this.$picker.data(t)},a.prototype.get_padded_date_range=function(t,e,a){t=t||this.get_default_date(),e=e||30,a=a||7;var i=new Date,n=t<i,s=new Date(t.setDate(n?i.getDate():"01")),r=new Date(s.getTime());return s.setDate(s.getDate()-(n?0:a)),r.setDate(r.getDate()+(e+a)),s<i&&(s=i),{startDate:s,endDate:r}},a.prototype.getDateElementAttributes=function(t){var e={"class":[],title:"",selectable:!0},a=0<this.$form.find("select#wc_appointments_field_staff").val()?this.$form.find("select#wc_appointments_field_staff").val():0,i=t.getFullYear(),n=t.getMonth()+1,s=t.getDate(),r=t.getDay(),d=new Date(t),_=new Date,o=_.getFullYear(),p=_.getMonth()+1,c=_.getDate(),l=i+"-"+n+"-"+s,u=this.$picker.datepicker("option","minDate"),f=wc_appointments_date_picker.get_relative_date(u);if(e["class"].push("weekday-"+r),void 0!==y&&void 0!==g&&(y.setHours(HOUR_OFFSET),g.setHours(HOUR_OFFSET)),y<=t&&t<=g&&e["class"].push("ui-datepicker-selected-day"),wc_appointments_date_picker.get_format_date(d)<wc_appointments_date_picker.get_format_date(f)&&0!==parseInt(u)&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),this.appointmentsData.unavailable_days&&this.appointmentsData.unavailable_days[l]&&this.appointmentsData.unavailable_days[l][a]&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),this.appointmentsData.padding_days&&this.appointmentsData.padding_days[l]&&(this.appointmentsData.padding_days[l][0]||this.appointmentsData.padding_days[l][a])&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),this.appointmentsData.restricted_days&&undefined===this.appointmentsData.restricted_days[r]&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),""+i+n+s<wc_appointment_form_params.current_time&&(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=!1,e["class"].push("not_appointable")),this.appointmentsData.fully_scheduled_days[l]){if(this.appointmentsData.fully_scheduled_days[l][0]||this.appointmentsData.fully_scheduled_days[l][a])return e.title=wc_appointment_form_params.i18n_date_fully_scheduled,e.selectable=!1,e["class"].push("fully_scheduled"),e;"automatic"===this.appointmentsData.staff_assignment&&e["class"].push("partial_scheduled")}this.appointmentsData.partially_scheduled_days&&this.appointmentsData.partially_scheduled_days[l]&&(("automatic"===this.appointmentsData.staff_assignment||this.appointmentsData.has_staff&&0===a||this.appointmentsData.partially_scheduled_days[l][0]||this.appointmentsData.partially_scheduled_days[l][a])&&e["class"].push("partial_scheduled"),this.appointmentsData.remaining_scheduled_days[l]&&this.appointmentsData.remaining_scheduled_days[l][0]?e["class"].push("remaining_scheduled_"+this.appointmentsData.remaining_scheduled_days[l][0]):this.appointmentsData.remaining_scheduled_days[l]&&this.appointmentsData.remaining_scheduled_days[l][a]&&e["class"].push("remaining_scheduled_"+this.appointmentsData.remaining_scheduled_days[l][a])),new Date(i,n,s)<new Date(o,p,c)&&e["class"].push("past_day");var m={start_date:t,number_of_days:wc_appointments_date_picker.get_number_of_days(this.appointmentsData.appointment_duration,this.$form,this.$picker),fully_scheduled_days:this.appointmentsData.fully_scheduled_days,availability:this.appointmentsData.availability_rules,default_availability:this.appointmentsData.default_availability,has_staff:this.appointmentsData.has_staff,staff_id:a,staff_assignment:this.appointmentsData.staff_assignment},h=wc_appointments_date_picker.is_slot_appointable(m);return h?(-1<e["class"].indexOf("partial_scheduled")?e.title=wc_appointment_form_params.i18n_date_partially_scheduled:-1<e["class"].indexOf("past_day")?e.title=wc_appointment_form_params.i18n_date_unavailable:e.title=wc_appointment_form_params.i18n_date_available,e["class"].push("appointable")):(e.title=wc_appointment_form_params.i18n_date_unavailable,e.selectable=h,0===a?e["class"]=[this.appointmentsData.fully_scheduled_days[l]?"fully_scheduled":"not_appointable"]:this.appointmentsData.fully_scheduled_days[l]&&this.appointmentsData.fully_scheduled_days[l][a]&&(e["class"]=[this.appointmentsData.fully_scheduled_days[l][a]?"fully_scheduled":"not_appointable"])),e},moment.locale(t),(wc_appointments_date_picker=d).init()});